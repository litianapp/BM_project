---
title: "Data Exploration"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(corrplot)
library(patchwork)
```

Load the cancer registry data

```{r message = FALSE, warning = FALSE}

cancer_data = read_csv(file = "./data/Cancer_Registry.csv") %>% 
  janitor::clean_names()
```

Obtain summary statistics for all variables

```{r}

numerical = cancer_data%>%
  select(-c(binned_inc, geography))

Minimum = sapply(numerical, min, na.rm = 'TRUE')
Maximum = sapply(numerical, max, na.rm = 'TRUE')
Mean = sapply(numerical, mean, na.rm = 'TRUE')
Median = sapply(numerical, median, na.rm = 'TRUE')
SD = sapply(numerical, sd, na.rm = 'TRUE')
IQR = sapply(numerical, IQR, na.rm='TRUE')
Size = sapply(numerical, length)
Missing = sapply(numerical, function(x) sum(is.na(x)))

rbind(Minimum, Maximum, Mean, SD, Median, IQR, Size, Missing) %>%
  round(digits = 2)

```

Note that: some_college = 2285 out of 3047 missing values, employed = 152 out of 3047 missing values, and private_coverage_only = 609 out of 3047 missing values. Some college has too many missing values so it might be advisable not include it in the list of potential covariates

Create a separate dataset without the missing values

```{r}

clean_cancer_data = cancer_data%>%
  select(-pct_some_col18_24)%>%
  na.omit()



```

Figure out if there are variables that are highly correlated/provide the same information

```{r}
continuous_data = clean_cancer_data%>%
  select(-c(binned_inc, geography))

cor(continuous_data)%>%
  corrplot(method = "circle", diag=FALSE)
```

From literature review and preliminary discussions, we decided to remove binned_inc, pct_some_col_18_24, median_age, geography, avg_eaths_per_year, and pop_est_2015 from the saturated model.

Now, lets observe the distributions of potential covariates and observe if transformations are needed

```{r}

reduced_clean = clean_cancer_data%>%
  select(-c(binned_inc, geography, median_age, avg_deaths_per_year, pop_est2015))
```

Create a function that plots and performs tranformations on the variables

```{r warning = FALSE, message = FALSE}

distribution = function(variable) {

  reduced_clean = tibble(variable)
  
  reduced_clean%>%
    ggplot(aes(variable))+
    geom_histogram()
}

inspection = function(variable) {

  reduced_clean = tibble(variable)

  #Observe transformations

  transformations = reduced_clean%>%
    dplyr::select(variable)%>%
    mutate(log_variable = log(variable),
          sqrt_variable = sqrt(variable),
          inverse_variable = 1 / variable)%>%
    gather(key = type, value = value)
  
  a = transformations%>%
    filter(type == "variable")%>%
    ggplot(aes(value))+
    geom_density()+
    labs(x = "Original",
        y = "Frequency")

  b = transformations%>%
    filter(type == "sqrt_variable")%>%
    ggplot(aes(value))+
    geom_density()+
    labs(x = "Sqrt(Variable)",
        y = "Frequency")

  c = transformations%>%
    filter(type == "inverse_variable")%>%
    ggplot(aes(value))+
    geom_density()+
    labs(x = "Inverse(Variable)",
        y = "Frequency")

  d = transformations%>%
    filter(type == "log_variable")%>%
    ggplot(aes(value))+
    geom_density()+
    labs(x = "log(Variable)",
        y = "Frequency")

  (a + b) / (c + d)
  
}

```


Average annual count has one extreme outlier, making the distribution of the points to be right skewed. Log tranformation most reduces the skewness

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$avg_ann_count

distribution(variable)
inspection(variable)

#perform a log tranformation
model_data = reduced_clean%>%
  mutate(log_avg_ann_count = log(avg_ann_count))

```

The distribution of incidence rate seems to be appropriately clustered, with a few outliers. Transformations result in similar shapes as the original

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$incidence_rate

distribution(variable)
inspection(variable)
```

Median income is slighly right skewed and the inverse transformation reduces most of the skewness. Transformation also may not be necessary in this case

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$med_income

distribution(variable)
inspection(variable)

#perform an inverse tranformation
model_data = model_data%>%
  mutate(inverse_med_income = 1/(med_income))
```

Poverty percent is slightly right skewed and the square root transformation reduces most of the skewness. Transformation also may not be necessary in this case

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$poverty_percent

distribution(variable)
inspection(variable)

#perform a square root tranformation
model_data = model_data%>%
  mutate(sqrt_poverty_rate = sqrt(poverty_percent))

```

Study per cap is highly right skewed and the log transformation reduces most of the skewness

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$study_per_cap

distribution(variable)
inspection(variable)

#perform a log tranformation
model_data = model_data%>%
  mutate(log_study_per_cap = log(study_per_cap))

```

Median age for males has an appropriate shape and does not need transformation

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$median_age_male

distribution(variable)
inspection(variable)


```

Median age for females has an appropriate shape and does not need transformation

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$median_age_female

distribution(variable)
inspection(variable)


```

Average household size has some unusual values. A majority of the points are clustured around 2.5 and there is a slight skewness to the right. However, there are some outliers to the left that are close to 0. None of the transformations are useful - the log transformation removes the slight right skewness but we still see a another bump to the left 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$avg_household_size

distribution(variable)
inspection(variable)

#Perform a log transformation
model_data = model_data%>%
  mutate(log_avg_household_size = log(avg_household_size))

```

Percent married is slightly left skewed but none of the transformation perform better, in terms of skewness

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$percent_married

distribution(variable)
inspection(variable)

```

pct_no_hs18_24 is slightly right skewed and the square root transformation reduces most of the skewness. However, a transformation might not be necessary in this case 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_no_hs18_24


distribution(variable)
inspection(variable)


#Perform a square root transformation
model_data = model_data%>%
  mutate(sqrt_pct_no_hs18_24 = sqrt(pct_no_hs18_24))

```

pct_hs18_24 is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_hs18_24


distribution(variable)
inspection(variable)

```

##################################################################################################

pct_bach_deg18_24 is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_bach_deg18_24


distribution(variable)
inspection(variable)

```

pct_hs25_over is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_hs25_over


distribution(variable)
inspection(variable)

```

pct_bach_deg25_over is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_bach_deg25_over


distribution(variable)
inspection(variable)

```

pct_employed16_over is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_employed16_over


distribution(variable)
inspection(variable)

```

pct_unemployed16_over is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_unemployed16_over


distribution(variable)
inspection(variable)

```

pct_private_coverage is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_private_coverage


distribution(variable)
inspection(variable)

```

pct_private_coverage_alone is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_private_coverage_alone


distribution(variable)
inspection(variable)

```

pct_emp_priv_coverage is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_emp_priv_coverage


distribution(variable)
inspection(variable)

```

pct_public_coverage is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_public_coverage


distribution(variable)
inspection(variable)

```

pct_public_coverage_alone is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_public_coverage_alone


distribution(variable)
inspection(variable)

```

pct_white is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_white


distribution(variable)
inspection(variable)

```

pct_black is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_black


distribution(variable)
inspection(variable)

```

pct_asian is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_asian


distribution(variable)
inspection(variable)

```

pct_other_race is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_other_race


distribution(variable)
inspection(variable)

```

pct_married_households is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$pct_married_households


distribution(variable)
inspection(variable)

```

birth_rate is appropriately shaped 

```{r warning = FALSE, message = FALSE}

variable = reduced_clean$birth_rate


distribution(variable)
inspection(variable)

```


Create a full model (with all transformations, including questionable ones)

```{r eval = FALSE}
lm(target_death_rate ~ log_avg_ann_count, incidence_rate, inverse_med_income, sqrt_poverty_rate,
   log_study_per_cap, median_age_male, median_age_female, log_avg_household_size, percent_married,
   sqrt_pct_no_hs18_24, 
   data = model_data
```

Create a full model (with transformations, not including questionable ones)

```{r eval=FALSE}
lm(target_death_rate ~ log_avg_ann_count, incidence_rate, med_income, poverty_rate,
   log_study_per_cap, median_age_male, median_age_female, avg_household_size, percent_married,
   pct_no_hs18_24, 
   data = model_data
```


